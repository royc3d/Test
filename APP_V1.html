<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Beleženje osebnih financ</title>
  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Dodatni stili: temni način in stil za levi meni -->
  <style>
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    body.dark-mode .card {
      background-color: #1e1e1e;
      color: #e0e0e0;
    }
    body.dark-mode .table {
      color: #e0e0e0;
    }
    /* Stil za levi meni */
    #sidebar .list-group-item.active {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
  </style>
  <!-- Chart.js (vključen, čeprav analize prikazujemo v tabelah) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (XLSX) za uvoz/izvoz Excel datotek -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Google API (za Google Drive integracijo) -->
  <script async defer src="https://apis.google.com/js/api.js" onload="handleClientLoad()"></script>
</head>
<body>
  <!-- Glavni layout: levi meni in glavni vsebinski del -->
  <div class="container-fluid">
    <div class="row">
      <!-- Levi meni -->
      <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
        <div class="position-sticky pt-3">
          <div class="list-group" id="sidebar">
            <a href="#" class="list-group-item list-group-item-action active" data-page="page1">Vnos transakcije</a>
            <a href="#" class="list-group-item list-group-item-action" data-page="page2">Vse transakcije</a>
            <a href="#" class="list-group-item list-group-item-action" data-page="page3">Uvoz/Izvoz datotek</a>
            <a href="#" class="list-group-item list-group-item-action" data-page="page4">Analiza podatkov</a>
            <a href="#" class="list-group-item list-group-item-action" data-page="page5">Brisanje podatkov</a>
            <a href="#" class="list-group-item list-group-item-action" data-page="page6">Google Drive nastavitve</a>
            <a href="#" class="list-group-item list-group-item-action" data-page="page7">Nastavitve</a>
          </div>
        </div>
      </nav>

      <!-- Glavni vsebinski del -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4" id="mainContent">
        <!-- Obvestilni container -->
        <div id="notificationContainer"></div>

        <!-- Page 1: Vnos transakcije -->
        <div id="page1" class="page">
          <h2 class="mt-3">Vnos transakcije</h2>
          <div class="card mb-4">
            <div class="card-header">Dodaj/Uredi transakcijo</div>
            <div class="card-body">
              <form id="transactionForm">
                <input type="hidden" id="transactionId">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label for="date" class="form-label">Datum</label>
                    <!-- Vnos datuma (HTML input tipa date vrne yyyy-mm-dd; pretvorba v dd.mm.yyyy se izvede ob vnosu) -->
                    <input type="date" class="form-control" id="date" required>
                  </div>
                  <div class="col-md-3">
                    <label for="type" class="form-label">Tip</label>
                    <select class="form-select" id="type" required>
                      <option value="prihodek">Prihodek</option>
                      <option value="odhodki">Odhodki</option>
                      <option value="investicija">Investicija</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="category" class="form-label">Kategorija</label>
                    <!-- Seznam kategorij se bo napolnil dinamično -->
                    <select class="form-select" id="category" required></select>
                  </div>
                  <div class="col-md-3">
                    <label for="amount" class="form-label">Znesek</label>
                    <input type="number" class="form-control" id="amount" step="0.01" required>
                  </div>
                  <div class="col-12">
                    <label for="description" class="form-label">Opis</label>
                    <textarea class="form-control" id="description" rows="2"></textarea>
                  </div>
                  <div class="col-12">
                    <button type="submit" class="btn btn-primary">Shrani</button>
                    <button type="button" id="cancelEdit" class="btn btn-secondary" style="display:none;">Prekliči urejanje</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Page 2: Vse transakcije (inline urejanje) -->
        <div id="page2" class="page" style="display:none;">
          <h2 class="mt-3">Vse transakcije</h2>
          <div class="card mb-4">
            <div class="card-header">Seznam transakcij</div>
            <div class="card-body">
              <table class="table table-striped" id="transactionTable">
                <thead>
                  <tr>
                    <th>Datum</th>
                    <th>Tip</th>
                    <th>Kategorija</th>
                    <th>Znesek</th>
                    <th>Opis</th>
                    <th>Akcije</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Dinamični vnosi bodo tukaj -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Page 3: Uvoz/Izvoz datotek -->
        <div id="page3" class="page" style="display:none;">
          <h2 class="mt-3">Uvoz/Izvoz datotek</h2>
          <div class="card mb-4">
            <div class="card-header">Import / Export Excel</div>
            <div class="card-body">
              <div class="mb-3">
                <label for="excelFile" class="form-label">Import Excel datoteko</label>
                <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" class="form-control">
                <small class="text-muted">
                  Struktura: Datum, Prihodki / Odhodki / Investicija, Znesek, Kategorija, Opis.
                  <br>(Datumi v obliki dd.mm.yyyy)
                </small>
              </div>
              <button id="exportExcel" class="btn btn-primary">Export v Excel</button>
            </div>
          </div>
        </div>

        <!-- Page 4: Analiza podatkov – samo seštevek prihodkov in odhodkov za izbran mesec + tabela z razčlenitvijo odhodkov po kategorijah -->
        <div id="page4" class="page" style="display:none;">
          <h2 class="mt-3">Analiza podatkov</h2>
          <div class="mb-3">
            <label for="analysisMonth" class="form-label">Izberi mesec in leto za analizo</label>
            <input type="month" id="analysisMonth" class="form-control">
          </div>
          <div id="dataAnalysis">
            <!-- Prikaz seštevka prihodkov in odhodkov in tabela odhodkov po kategorijah bo tukaj -->
          </div>
        </div>

        <!-- Page 5: Brisanje podatkov -->
        <div id="page5" class="page" style="display:none;">
          <h2 class="mt-3">Brisanje podatkov</h2>
          <div class="card mb-4">
            <div class="card-header">Brisanje vseh podatkov</div>
            <div class="card-body">
              <button id="clearAllData" class="btn btn-danger">Izbriši vse podatke</button>
            </div>
          </div>
        </div>

        <!-- Page 6: Google Drive nastavitve -->
        <div id="page6" class="page" style="display:none;">
          <h2 class="mt-3">Google Drive nastavitve</h2>
          <div class="card mb-4">
            <div class="card-header">Nastavitve za Google Drive</div>
            <div class="card-body">
              <div id="googleDriveSettings">
                <div class="mb-3">
                  <label for="googleClientId" class="form-label">Google Client ID</label>
                  <input type="text" id="googleClientId" class="form-control">
                </div>
                <div class="mb-3">
                  <label for="googleApiKey" class="form-label">Google API Key</label>
                  <input type="text" id="googleApiKey" class="form-control">
                </div>
                <div class="mb-3">
                  <label for="googleFolderId" class="form-label">Google Folder ID</label>
                  <input type="text" id="googleFolderId" class="form-control">
                </div>
                <button id="saveGoogleSettings" class="btn btn-primary">Shrani nastavitve</button>
                <button id="authorizeGoogle" class="btn btn-secondary">Avtoriziraj Google Drive</button>
                <div id="googleStatus" class="mt-2"></div>
              </div>
              <hr>
              <p class="text-muted">
                Ob vsakem novem vnosu se Excel datoteka ustvari in (če ste avtorizirani) naloži na Google Drive.
              </p>
            </div>
          </div>
        </div>

        <!-- Page 7: Nastavitve (urejanje kategorij) -->
        <div id="page7" class="page" style="display:none;">
          <h2 class="mt-3">Nastavitve - Urejanje kategorij</h2>
          <div class="card mb-4">
            <div class="card-header">Urejanje kategorij</div>
            <div class="card-body">
              <div class="mb-3">
                <label for="newCategory" class="form-label">Nova kategorija</label>
                <input type="text" id="newCategory" class="form-control" placeholder="Vnesi kategorijo">
              </div>
              <button id="addCategory" class="btn btn-primary mb-3">Dodaj kategorijo</button>
              <h5>Trenutne kategorije:</h5>
              <ul id="categoryList" class="list-group">
                <!-- Seznam kategorij bo generiran tukaj -->
              </ul>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Registracija Service Workerja -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js').then(function(registration) {
          console.log('ServiceWorker uspešno registriran, obseg:', registration.scope);
        }, function(err) {
          console.log('Registracija ServiceWorkerja ni uspela:', err);
        });
      });
    }
  </script>

  <!-- Glavna JavaScript logika -->
  <script>
    /*********************** GLOBALNE SPREMENLJIVKE ***********************/
    let transactions = [];
    let editTransactionId = null;
    let monthlyBudget = 0;
    let showAllTransactions = false;  // prikaz samo prvih 5 transakcij

    // Google Drive spremenljivke (nastavitve shranjene v localStorage)
    let CLIENT_ID = '';
    let API_KEY = '';
    let FOLDER_ID = '';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    /*********************** NAVIGACIJA (LEVI MENI) ***********************/
    document.querySelectorAll('#sidebar a').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('#sidebar a').forEach(a => a.classList.remove('active'));
        this.classList.add('active');
        const pageToShow = this.getAttribute('data-page');
        document.querySelectorAll('.page').forEach(page => {
          page.style.display = (page.id === pageToShow) ? 'block' : 'none';
        });
      });
    });

    /*********************** OBVESTILA ***********************/
    function showNotification(message, type = 'info') {
      const container = document.getElementById('notificationContainer');
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show';
      alertDiv.role = 'alert';
      alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
      container.appendChild(alertDiv);
      setTimeout(() => {
        alertDiv.classList.remove('show');
        alertDiv.classList.add('hide');
        setTimeout(() => alertDiv.remove(), 500);
      }, 3000);
    }

    /*********************** LOCALSTORAGE ***********************/
    function saveTransactionsToLocalStorage() {
      localStorage.setItem('transactions', JSON.stringify(transactions));
    }
    function loadTransactionsFromLocalStorage() {
      const stored = localStorage.getItem('transactions');
      if (stored) {
        transactions = JSON.parse(stored);
      }
    }
    function saveBudgetToLocalStorage() {
      localStorage.setItem('monthlyBudget', monthlyBudget);
    }

    /*********************** POMOŽNA FUNKCIJA ZA PRETVORBO EXCEL DATUMA ***********************/
    function excelDateToJSDate(serial) {
      return new Date(Math.round((serial - 25569) * 86400 * 1000));
    }

    /*********************** TRANSAKCIJSKA TABELA (PAGE 2) – INLINE UREJANJE ***********************/
    document.getElementById('transactionTable').addEventListener('click', function(e) {
      const btn = e.target.closest('button');
      if (!btn) return;
      if (btn.classList.contains('edit-btn')) {
        const row = btn.closest('tr');
        const id = btn.getAttribute('data-id');
        const tx = transactions.find(t => t.id === id);
        if (!tx) return;
        if (row.getAttribute('data-editing') === 'true') return;
        row.setAttribute('data-editing', 'true');
        const originalContent = row.innerHTML;
        row.setAttribute('data-original', originalContent);
        row.innerHTML = `
          <td><input type="text" class="form-control form-control-sm edit-date" value="${tx.date}"></td>
          <td>
            <select class="form-select form-select-sm edit-type">
              <option value="prihodek" ${tx.type==='prihodek' ? 'selected' : ''}>Prihodek</option>
              <option value="odhodki" ${tx.type==='odhodki' ? 'selected' : ''}>Odhodki</option>
              <option value="investicija" ${tx.type==='investicija' ? 'selected' : ''}>Investicija</option>
            </select>
          </td>
          <td>
            <select class="form-select form-select-sm edit-category"></select>
          </td>
          <td><input type="number" class="form-control form-control-sm edit-amount" value="${tx.amount}"></td>
          <td><input type="text" class="form-control form-control-sm edit-description" value="${tx.description}"></td>
          <td>
            <button class="btn btn-sm btn-success save-btn" data-id="${tx.id}">Shrani</button>
            <button class="btn btn-sm btn-secondary cancel-btn" data-id="${tx.id}">Prekliči</button>
          </td>
        `;
        const categorySelect = row.querySelector('.edit-category');
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          if (cat === tx.category) option.selected = true;
          categorySelect.appendChild(option);
        });
      }
      else if (btn.classList.contains('save-btn')) {
        const row = btn.closest('tr');
        const id = btn.getAttribute('data-id');
        const txIndex = transactions.findIndex(t => t.id === id);
        if (txIndex === -1) return;
        const newDate = row.querySelector('.edit-date').value.trim();
        const newType = row.querySelector('.edit-type').value;
        const newCategory = row.querySelector('.edit-category').value;
        const newAmount = parseFloat(row.querySelector('.edit-amount').value);
        const newDescription = row.querySelector('.edit-description').value;
        transactions[txIndex].date = newDate;
        transactions[txIndex].type = newType;
        transactions[txIndex].category = newCategory;
        transactions[txIndex].amount = newAmount;
        transactions[txIndex].description = newDescription;
        saveTransactionsToLocalStorage();
        refreshTransactionTable();
        updateExpenseAnalysis();
        showNotification('Transakcija posodobljena!', 'success');
      }
      else if (btn.classList.contains('cancel-btn')) {
        refreshTransactionTable();
      }
      else if (btn.classList.contains('delete-btn')) {
        const id = btn.getAttribute('data-id');
        transactions = transactions.filter(t => t.id !== id);
        saveTransactionsToLocalStorage();
        refreshTransactionTable();
        updateExpenseAnalysis();
        showNotification('Transakcija izbrisana!', 'warning');
      }
    });
    function refreshTransactionTable() {
      const tbody = document.querySelector('#transactionTable tbody');
      tbody.innerHTML = '';
      let displayTransactions = transactions;
      let showToggle = false;
      if (!showAllTransactions && transactions.length > 5) {
        displayTransactions = transactions.slice(0, 5);
        showToggle = true;
      }
      displayTransactions.forEach(tx => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${tx.date}</td>
          <td>${tx.type === 'prihodek' ? 'Prihodek' : (tx.type === 'odhodki' ? 'Odhodki' : 'Investicija')}</td>
          <td>${tx.category}</td>
          <td>${tx.amount.toFixed(2)}</td>
          <td>${tx.description}</td>
          <td>
            <button class="btn btn-sm btn-warning edit-btn" data-id="${tx.id}">Uredi</button>
            <button class="btn btn-sm btn-danger delete-btn" data-id="${tx.id}">Izbriši</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      if (showToggle) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'btn btn-sm btn-link';
        toggleBtn.innerText = 'Prikaži več';
        toggleBtn.addEventListener('click', function() {
          showAllTransactions = true;
          refreshTransactionTable();
        });
        td.appendChild(toggleBtn);
        tr.appendChild(td);
        tbody.appendChild(tr);
      } else if (showAllTransactions && transactions.length > 5) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'btn btn-sm btn-link';
        toggleBtn.innerText = 'Prikaži manj';
        toggleBtn.addEventListener('click', function() {
          showAllTransactions = false;
          refreshTransactionTable();
        });
        td.appendChild(toggleBtn);
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    /*********************** TRANSAKCIJSKI OBRAZEC (PAGE 1) ***********************/
    document.getElementById('transactionForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const rawDate = document.getElementById('date').value;
      const date = convertDateISOtoDDMMYYYY(rawDate);
      const type = document.getElementById('type').value;
      const category = document.getElementById('category').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const description = document.getElementById('description').value;
      if (editTransactionId) {
        const tx = transactions.find(t => t.id === editTransactionId);
        if (tx) {
          tx.date = date;
          tx.type = type;
          tx.category = category;
          tx.amount = amount;
          tx.description = description;
          showNotification('Transakcija posodobljena!', 'success');
        }
        editTransactionId = null;
        document.getElementById('cancelEdit').style.display = 'none';
      } else {
        const tx = { id: Date.now().toString(), date, type, category, amount, description };
        transactions.push(tx);
        showNotification('Transakcija dodana!', 'success');
      }
      saveTransactionsToLocalStorage();
      refreshTransactionTable();
      updateExpenseAnalysis();
      if (window.gapi && gapi.auth2 && gapi.auth2.getAuthInstance().isSignedIn.get()) {
        exportTransactionsToExcelAndUploadToDrive();
      }
      this.reset();
      document.getElementById('transactionId').value = '';
    });

    /*********************** POMOŽNA FUNKCIJA ZA FORMATIRANJE DATUMA ***********************/
    function convertDateISOtoDDMMYYYY(dateStr) {
      const parts = dateStr.split('-');
      if (parts.length === 3) {
        return parts[2] + "." + parts[1] + "." + parts[0];
      }
      return dateStr;
    }

    /*********************** ANALIZA PODATKOV (PAGE 4) – SEŠTEVEK PRIHODKOV IN ODHODKOV ***********************/
    function updateExpenseAnalysis() {
      let selectedMonth = document.getElementById('analysisMonth').value;
      if (!selectedMonth) {
        const now = new Date();
        selectedMonth = now.toISOString().slice(0,7);
        document.getElementById('analysisMonth').value = selectedMonth;
      }
      const selectedYear = selectedMonth.slice(0,4);
      const selectedMonthNum = selectedMonth.slice(5,7);
      
      let totalIncome = 0;
      let totalExpense = 0;
      
      // Agregiramo samo transakcije tipa "prihodek" in "odhodki" (investicije se ne upoštevajo pri tem izračunu)
      transactions.forEach(tx => {
        if (typeof tx.date !== 'string') return;
        const parts = tx.date.trim().split('.');
        if (parts.length !== 3) return;
        const [day, mon, year] = parts;
        if (year === selectedYear && mon === selectedMonthNum) {
          if (tx.type === 'prihodek') {
            totalIncome += tx.amount;
          } else if (tx.type === 'odhodki') {
            totalExpense += tx.amount;
          }
        }
      });
      
      let html = `<h4>Analiza za ${selectedMonth}</h4>`;
      html += `<table class="table table-sm"><tbody>`;
      html += `<tr><td>Prihodki</td><td>${totalIncome.toFixed(2)} EUR</td></tr>`;
      html += `<tr><td>Odhodki</td><td>${totalExpense.toFixed(2)} EUR</td></tr>`;
      html += `<tr><td>Neto</td><td>${(totalIncome - totalExpense).toFixed(2)} EUR</td></tr>`;
      html += `</tbody></table>`;
      
      // Dodatna tabela: razčlenitev odhodkov po kategorijah
      const expenseByCategory = {};
      transactions.forEach(tx => {
        if (typeof tx.date !== 'string') return;
        const parts = tx.date.trim().split('.');
        if (parts.length !== 3) return;
        const [day, mon, year] = parts;
        if (year === selectedYear && mon === selectedMonthNum && tx.type === 'odhodki') {
          expenseByCategory[tx.category] = (expenseByCategory[tx.category] || 0) + tx.amount;
        }
      });
      const categoriesSorted = Object.keys(expenseByCategory).sort((a, b) => expenseByCategory[b] - expenseByCategory[a]);
      if (categoriesSorted.length > 0) {
        const topCategory = categoriesSorted[0];
        html += `<h4>Največ porabljana kategorija</h4>`;
        html += `<p><strong>${topCategory}</strong> z zneskom ${expenseByCategory[topCategory].toFixed(2)} EUR</p>`;
        
        html += `<h4>Razčlenitev odhodkov po kategorijah</h4>`;
        html += `<table class="table table-sm"><thead><tr><th>Kategorija</th><th>Znesek (EUR)</th></tr></thead><tbody>`;
        categoriesSorted.forEach(cat => {
          html += `<tr><td>${cat}</td><td>${expenseByCategory[cat].toFixed(2)}</td></tr>`;
        });
        html += `</tbody></table>`;
      }
      
      document.getElementById('dataAnalysis').innerHTML = html;
    }
    document.getElementById('analysisMonth').addEventListener('change', updateExpenseAnalysis);

    /*********************** UVOZ/IZVOZ EXCEL (PAGE 3) ***********************/
    document.getElementById('excelFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        // Uvozimo vrstice, ki imajo vsaj 4 stolpce (Datum, Tip, Znesek, Kategorija)
        for (let i = 1; i < jsonData.length; i++) {
          const row = jsonData[i];
          if (row.length < 4) continue;
          let [rawDatum, tip, znesek, kategorija, opis] = row;
          if (typeof opis === "undefined") {
            opis = "";
          }
          let tipLower = tip.toString().trim().toLowerCase();
          let type;
          if (tipLower === "prihodki" || tipLower === "prihodek") {
            type = "prihodek";
          } else if (tipLower === "odhodki" || tipLower === "odhodek") {
            type = "odhodki";
          } else if (tipLower === "investicija") {
            type = "investicija";
          } else if (tipLower.indexOf("/") !== -1) {
            const parts = tipLower.split("/");
            for (let part of parts) {
              part = part.trim();
              if (part === "prihodki" || part === "prihodek") {
                type = "prihodek";
                break;
              } else if (part === "odhodki" || part === "odhodek") {
                type = "odhodki";
                break;
              } else if (part === "investicija") {
                type = "investicija";
                break;
              }
            }
            if (!type) {
              type = "odhodki";
            }
          } else {
            type = "odhodki";
          }
          const amount = parseFloat(znesek.toString().replace(',', '.'));
          let formattedDate = "";
          if (typeof rawDatum === 'number') {
            let dateObj = excelDateToJSDate(rawDatum);
            formattedDate = ("0" + dateObj.getDate()).slice(-2) + "." +
                            ("0" + (dateObj.getMonth() + 1)).slice(-2) + "." +
                            dateObj.getFullYear();
          } else {
            formattedDate = rawDatum.toString().trim();
          }
          const tx = {
            id: Date.now().toString() + i,
            date: formattedDate,
            type: type,
            category: kategorija,
            amount: amount,
            description: opis
          };
          transactions.push(tx);
        }
        saveTransactionsToLocalStorage();
        refreshTransactionTable();
        updateExpenseAnalysis();
        showNotification('Transakcije uvožene iz Excel datoteke!', 'success');
      };
      reader.readAsArrayBuffer(file);
    });
    function exportTransactionsToExcel() {
      const data = [['Datum', 'Prihodki / Odhodki / Investicija', 'Znesek', 'Kategorija', 'Opis']];
      transactions.forEach(tx => {
        let typeStr = "";
        if (tx.type === 'prihodek') typeStr = "Prihodki";
        else if (tx.type === 'odhodki') typeStr = "Odhodki";
        else if (tx.type === 'investicija') typeStr = "Investicija";
        data.push([tx.date, typeStr, tx.amount, tx.category, tx.description]);
      });
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "Transakcije");
      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const fileName = 'Transakcije_' + new Date().toISOString().slice(0,19).replace(/:/g, '-') + '.xlsx';
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showNotification('Transakcije so bile izvožene v Excel!', 'success');
    }
    document.getElementById('exportExcel').addEventListener('click', exportTransactionsToExcel);
    function exportTransactionsToExcelAndUploadToDrive() {
      const data = [['Datum', 'Prihodki / Odhodki / Investicija', 'Znesek', 'Kategorija', 'Opis']];
      transactions.forEach(tx => {
        let typeStr = "";
        if (tx.type === 'prihodek') typeStr = "Prihodki";
        else if (tx.type === 'odhodki') typeStr = "Odhodki";
        else if (tx.type === 'investicija') typeStr = "Investicija";
        data.push([tx.date, typeStr, tx.amount, tx.category, tx.description]);
      });
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "Transakcije");
      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const fileName = 'Transakcije_' + new Date().toISOString().slice(0,19).replace(/:/g, '-') + '.xlsx';
      uploadFileToDrive(blob, fileName);
    }

    /*********************** BRISANJE VSEH PODATKOV (PAGE 5) ***********************/
    document.getElementById('clearAllData').addEventListener('click', function() {
      if (confirm("Ste prepričani, da želite izbrisati vse podatke?")) {
        transactions = [];
        monthlyBudget = 0;
        localStorage.removeItem('transactions');
        localStorage.removeItem('monthlyBudget');
        refreshTransactionTable();
        updateExpenseAnalysis();
        showNotification('Vsi podatki so bili izbrisani!', 'warning');
      }
    });

    /*********************** GOOGLE DRIVE INTEGRACIJA (PAGE 6) ***********************/
    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }
    function initClient() {
      CLIENT_ID = localStorage.getItem('googleClientId') || '';
      API_KEY = localStorage.getItem('googleApiKey') || '';
      FOLDER_ID = localStorage.getItem('googleFolderId') || '';
      if (!CLIENT_ID || !API_KEY || !FOLDER_ID) {
        document.getElementById('googleStatus').innerText = 'Google Drive nastavitve niso popolne.';
        return;
      }
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(function () {
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        document.getElementById('authorizeGoogle').onclick = handleAuthClick;
      }, function(error) {
        console.error('Napaka pri inicializaciji gapi.client:', error);
      });
    }
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        document.getElementById('googleStatus').innerText = 'Google Drive: Prijavljeni';
      } else {
        document.getElementById('googleStatus').innerText = 'Google Drive: Ni prijavljenih';
      }
    }
    function handleAuthClick() {
      gapi.auth2.getAuthInstance().signIn();
    }
    function uploadFileToDrive(fileBlob, fileName) {
      if (!gapi.auth2.getAuthInstance().isSignedIn.get()) {
        alert('Ni avtorizacije za Google Drive.');
        return;
      }
      const accessToken = gapi.auth.getToken().access_token;
      const metadata = {
        name: fileName,
        mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        parents: [FOLDER_ID]
      };
      const formData = new FormData();
      formData.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
      formData.append('file', fileBlob);
      fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
        method: 'POST',
        headers: new Headers({'Authorization': 'Bearer ' + accessToken}),
        body: formData,
      }).then(response => response.json())
      .then(data => {
        console.log('Datoteka uspešno naložena:', data);
        showNotification('Excel datoteka naložena na Google Drive!', 'success');
      }).catch(error => {
        console.error('Napaka pri nalaganju datoteke:', error);
        showNotification('Napaka pri nalaganju na Google Drive', 'danger');
      });
    }
    document.getElementById('saveGoogleSettings').addEventListener('click', function() {
      const clientId = document.getElementById('googleClientId').value.trim();
      const apiKey = document.getElementById('googleApiKey').value.trim();
      const folderId = document.getElementById('googleFolderId').value.trim();
      if (!clientId || !apiKey || !folderId) {
        showNotification('Prosimo vnesite vse Google Drive nastavitve.', 'warning');
        return;
      }
      localStorage.setItem('googleClientId', clientId);
      localStorage.setItem('googleApiKey', apiKey);
      localStorage.setItem('googleFolderId', folderId);
      showNotification('Google Drive nastavitve shranjene!', 'success');
      if (gapi && gapi.auth2) {
        gapi.auth2.getAuthInstance().signOut().then(() => {
          initClient();
        });
      }
    });

    /*********************** NASTAVITVE KATEGORIJ (PAGE 7) ***********************/
    let defaultCategories = [
      "Hrana", "Sushi", "Najemnina", "Stroški", "Internet", "Mobitel", "Zavarovanje", "Gorivo", "Avtomobil", "Zdravje",
      "Skupni račun", "Potovanje", "Plača", "Investicije", "Investicije-Bitcoin", "Nedoločeno", "Trava", "Malica v službi",
      "Drones", "Tech", "Tobak", "Alkohol", "Za klapu", "Življensko", "Varčevalni račun", "Darila", "Mnčis", "Hrana za psa",
      "Osebna nega", "Oblačila", "Kava", "Kapice", "Za stanovanje", "Banka", "Gorivo štirikolesnik", "Stroški štirikolesnik",
      "Padalstvo", "Kategorija", "Stroški banka", "Otrok", "Kolesarstvo"
    ];
    let categories = [];
    function loadCategories() {
      const stored = localStorage.getItem('categories');
      if (stored) {
        categories = JSON.parse(stored);
      } else {
        categories = defaultCategories.slice();
        saveCategories();
      }
    }
    function saveCategories() {
      localStorage.setItem('categories', JSON.stringify(categories));
    }
    function populateCategorySelect() {
      const select = document.getElementById('category');
      if (!select) return;
      select.innerHTML = '';
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });
    }
    function populateCategoryList() {
      const ul = document.getElementById('categoryList');
      if (!ul) return;
      ul.innerHTML = '';
      categories.forEach((cat, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.textContent = cat;
        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-sm btn-danger';
        delBtn.textContent = 'Izbriši';
        delBtn.setAttribute('data-index', index);
        li.appendChild(delBtn);
        ul.appendChild(li);
      });
    }
    document.getElementById('addCategory').addEventListener('click', function() {
      const newCat = document.getElementById('newCategory').value.trim();
      if (newCat && !categories.includes(newCat)) {
        categories.push(newCat);
        saveCategories();
        populateCategorySelect();
        populateCategoryList();
        document.getElementById('newCategory').value = '';
        showNotification('Kategorija dodana!', 'success');
      } else {
        showNotification('Vnesite novo kategorijo, ki še ne obstaja.', 'warning');
      }
    });
    document.getElementById('categoryList').addEventListener('click', function(e) {
      if (e.target.tagName.toLowerCase() === 'button') {
        const index = e.target.getAttribute('data-index');
        if (index !== null) {
          const cat = categories[index];
          if (confirm(`Ste prepričani, da želite izbrisati kategorijo "${cat}"?`)) {
            categories.splice(index, 1);
            saveCategories();
            populateCategorySelect();
            populateCategoryList();
            showNotification('Kategorija izbrisana!', 'warning');
          }
        }
      }
    });

    /*********************** OB NALAGANJU STRANI ***********************/
    document.addEventListener('DOMContentLoaded', function() {
      loadTransactionsFromLocalStorage();
      refreshTransactionTable();
      updateExpenseAnalysis();
      const storedBudget = localStorage.getItem('monthlyBudget');
      if (storedBudget) {
        monthlyBudget = parseFloat(storedBudget);
      }
      document.getElementById('googleClientId').value = localStorage.getItem('googleClientId') || '';
      document.getElementById('googleApiKey').value = localStorage.getItem('googleApiKey') || '';
      document.getElementById('googleFolderId').value = localStorage.getItem('googleFolderId') || '';
      loadCategories();
      populateCategorySelect();
      populateCategoryList();
    });
    /*********************** KONEC ***********************/
  </script>
</body>
</html>
